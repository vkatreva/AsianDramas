@model AsianDramas.Models.Actor
@using System.Linq

@{
    ViewData["Title"] = "Actor details";
}

<h1>@Model.Name</h1>

<div class="row">
    <div class="col-md-4">
        @if (!string.IsNullOrEmpty(Model.ImageUrl))
        {
            <img src="@Model.ImageUrl" alt="@Model.Name" class="img-fluid rounded" />
        }
    </div>

    <div class="col-md-8">
        <p><strong>Birth date:</strong> @(Model.BirthDate?.ToString("d") ?? "-")</p>
        <p><strong>Nationality:</strong> @Model.Nationality</p>
        <p><strong>Popularity score:</strong> @Model.PopularityScore</p>
        <p><strong>Biography:</strong> @Model.Biography</p>

        @if (Model.DramaActors != null && Model.DramaActors.Any())
        {
            <h3>Dramas/Movies</h3>
            <ul>
                @foreach (var da in Model.DramaActors)
                {
                    <li>
                        <a asp-controller="Dramas" asp-action="Details" asp-route-id="@da.DramaId">
                            @da.Drama?.Title
                        </a>
                        @if (!string.IsNullOrEmpty(da.RoleName))
                        {
                            @: – @da.RoleName
                        }
                    </li>
                }
            </ul>
        }
    </div>
</div>

<hr />

<h4>User reviews</h4>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<div class="actor-action-bar mb-4">
    @if (User.Identity != null && User.Identity.IsAuthenticated)
    {
        <a asp-controller="ActorReviews"
           asp-action="Create"
           asp-route-actorId="@Model.Id"
           class="btn btn-purple mb-3">
            + Add Review
        </a>

    }
    else
    {
        <a asp-controller="Account"
           asp-action="Login"
           class="btn btn-ghost">
            Log in to write a review
        </a>
    }
</div>


<hr />

<h4>User Reviews (@(Model.Reviews?.Count() ?? 0))</h4>
<hr />

@if (Model.Reviews != null && Model.Reviews.Any())
{
    @foreach (var r in Model.Reviews.OrderByDescending(x => x.CreatedAt))
    {
        <div class="review-card">
            <div class="review-header">
                <div class="review-user">@((r.User?.Email ?? r.User?.UserName) ?? "User")</div>
                <div class="review-date">@r.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy 'г.' HH:mm")</div>
            </div>

            <div class="review-rating-line">
                <span>@r.Rating / 10</span>
            </div>

            <div class="stars">
                @for (int i = 1; i <= 10; i++)
                {
                    if (i <= r.Rating)
                    {
                        <span style="color:#f5c518;">&#9733;</span>
                    }
                    else
                    {
                        <span style="color:#555;">&#9733;</span>
                    }
                }
            </div>

            @if (!string.IsNullOrWhiteSpace(r.Comment))
            {
                <div class="review-comment">@r.Comment</div>
            }

            @if (User.Identity != null && User.Identity.IsAuthenticated &&
                r.UserId == User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value)

            {
                <div class="review-actions">
                    <a asp-controller="ActorReviews" asp-action="Edit" asp-route-id="@r.Id" class="btn-ghost btn-sm-ghost me-2">Edit</a>
                    <a asp-controller="ActorReviews"
                       asp-action="Delete"
                       asp-route-id="@r.Id"
                       class="btn-danger-custom btn-sm-danger">
                        Delete
                    </a>

                </div>
            }
        </div>

        <hr class="review-separator" />
    }

}
else
{
    <p>No reviews yet.</p>
}


<div class="actor-footer-actions mt-4 d-flex gap-2">
    @if (User.IsInRole("Admin"))
    {
        <a asp-action="Edit"
           asp-route-id="@Model.Id"
           class="btn btn-outline-light">
            Edit
        </a>

        <a asp-action="Delete"
           asp-route-id="@Model.Id"
           class="btn btn-outline-danger">
            Delete
        </a>
    }

    <a asp-action="Index"
       class="btn btn-ghost">
        ← Back to list
    </a>
</div>

